pipeline {
    agent any
    
    triggers {
        // –í–ê–†–ò–ê–ù–¢ 1: –î–ª—è GitHub (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å GitHub)
        githubPush()  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—É—à–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

        // –í–ê–†–ò–ê–ù–¢ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
        pollSCM('H/5 * * * *')  // –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

        // –í–ê–†–ò–ê–ù–¢ 3: –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 8 —É—Ç—Ä–∞)
        // cron('0 8 * * *')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo "–°–±–æ—Ä–∫–∞ –¥–ª—è –≤–µ—Ç–∫–∏: ${env.BRANCH_NAME}"
                echo "–ö–æ–º–º–∏—Ç: ${GIT_COMMIT}"
            }
        }

        stage('Build') {
            steps {
                echo 'üöÄ –°–±–æ—Ä–∫–∞ Railway ERP System...'
                sh '''
                    echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
                    echo "–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤:"
                    ls -la
                '''

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ compose.yaml
                script {
                    if (fileExists('compose.yaml')) {
                        echo 'üìÅ –ù–∞–π–¥–µ–Ω compose.yaml —Å PostgreSQL'
                        sh 'head -5 compose.yaml'
                    }
                }
            }
        }

        stage('Test') {
            steps {
                echo 'üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...'
                // –ü—Ä–∏–º–µ—Ä –¥–ª—è Java:
                // sh 'mvn test'
                // –ü—Ä–∏–º–µ—Ä –¥–ª—è Node.js:
                // sh 'npm test'
            }
        }

        stage('Deploy to Test') {
            when {
                branch 'main'  // –¢–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏
            }
            steps {
                echo 'üöö –î–µ–ø–ª–æ–π –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä...'
                // sh './deploy-test.sh'
            }
        }
    }

    post {
        always {
            echo 'üìä –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!'
            // –û—á–∏—Å—Ç–∫–∞, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ç.–¥.
        }
        success {
            echo '‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!'
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            // emailext to: 'team@example.com', subject: '–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞', body: '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!'
        }
        failure {
            echo '‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ—É—Å–ø–µ—à–Ω–∞!'
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            // emailext to: 'team@example.com', subject: '–°–±–æ—Ä–∫–∞ –Ω–µ—É—Å–ø–µ—à–Ω–∞', body: '–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ!'
        }
        changed {
            echo 'üîÑ –°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è!'
        }
    }

    // –û–∫—Ä—É–∂–µ–Ω–∏–µ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
    environment {
        // PROJECT_NAME = 'RailwayERP'
        // DEPLOY_ENV = 'test'
    }
}