name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Send Telegram Notification - Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=üöÄ GitHub Actions: Build Started\n\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nAuthor: ${{ github.actor }}" \
            -d "parse_mode=Markdown"

      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven (Java 17)
        run: |
          chmod +x mvnw
          echo "=== Java Version ==="
          java -version
          echo ""
          echo "=== Building with Maven ==="
          ./mvnw clean compile -DskipTests \
            -Djava.version=17 \
            -Dmaven.compiler.source=17 \
            -Dmaven.compiler.target=17

      - name: Run Tests
        run: |
          echo "=== Running Tests ==="
          ./mvnw test -Djava.version=17
        continue-on-error: true

      - name: Package Application
        run: |
          echo "=== Creating JAR Package ==="
          ./mvnw package -DskipTests -Djava.version=17
          echo ""
          echo "=== Generated JAR ==="
          ls -la target/*.jar

      - name: Send Telegram Notification - Result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            EMOJI="‚úÖ"
            STATUS="SUCCESS"
            MESSAGE="Build completed successfully!"
          elif [ "${{ job.status }}" == "failure" ]; then
            EMOJI="‚ùå"
            STATUS="FAILURE"
            MESSAGE="Build failed!"
          else
            EMOJI="‚ö†Ô∏è"
            STATUS="UNSTABLE"
            MESSAGE="Build completed with warnings."
          fi
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=$EMOJI GitHub Actions: Build Complete\n\nStatus: $STATUS\nBranch: ${{ github.ref_name }}\nMessage: $MESSAGE\n\nView Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -d "parse_mode=Markdown"

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: railwayerp-artifacts
          path: |
            target/*.jar
            pom.xml